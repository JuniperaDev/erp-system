<?xml version="1.0" encoding="utf-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.5.xsd">
    <!--
        Migrate existing dealer group relationships to new DealerGroup entity.
    -->
    <changeSet id="20250804184801-1" author="devin">
        <comment>Create DealerGroup records for existing dealer groups</comment>
        <sql>
            INSERT INTO dealer_group (id, group_name, description)
            SELECT DISTINCT d.id, d.dealer_name, CONCAT('Migrated dealer group: ', d.dealer_name)
            FROM dealer d
            WHERE d.id IN (
                SELECT DISTINCT dealer_group_id 
                FROM dealer 
                WHERE dealer_group_id IS NOT NULL
            );
        </sql>
    </changeSet>

    <changeSet id="20250804184801-2" author="devin">
        <comment>Drop old dealer self-reference constraint</comment>
        <dropForeignKeyConstraint baseTableName="dealer" constraintName="fk_dealer__dealer_group_id"/>
    </changeSet>

    <changeSet id="20250804184801-3" author="devin">
        <comment>Add new foreign key constraint to dealer_group table</comment>
        <addForeignKeyConstraint baseColumnNames="dealer_group_id"
                                 baseTableName="dealer"
                                 constraintName="fk_dealer__dealer_group_id"
                                 referencedColumnNames="id"
                                 referencedTableName="dealer_group"/>
    </changeSet>
</databaseChangeLog>
