<?xml version="1.0" encoding="utf-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.6.xsd
                        http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">

    <!--
        Rename IFRS16LeaseContract table to DetailedLeaseContract
        This migration standardizes entity naming by removing technical prefixes
    -->
    <changeSet id="20250804193122-1" author="devin">
        <comment>Rename ifrs16lease_contract table to detailed_lease_contract</comment>
        
        <!-- Rename the main table -->
        <renameTable oldTableName="ifrs16lease_contract" newTableName="detailed_lease_contract"/>
        
        <!-- Update sequence name if it exists -->
        <sql>
            ALTER SEQUENCE IF EXISTS ifrs16lease_contract_seq RENAME TO detailed_lease_contract_seq;
        </sql>
        
        <!-- Update any foreign key constraint names that reference the old table -->
        <sql>
            DO $$
            DECLARE
                constraint_record RECORD;
            BEGIN
                FOR constraint_record IN
                    SELECT conname, conrelid::regclass AS table_name
                    FROM pg_constraint
                    WHERE conname LIKE '%ifrs16lease_contract%'
                LOOP
                    EXECUTE 'ALTER TABLE ' || constraint_record.table_name || 
                           ' RENAME CONSTRAINT ' || constraint_record.conname || 
                           ' TO ' || REPLACE(constraint_record.conname, 'ifrs16lease_contract', 'detailed_lease_contract');
                END LOOP;
            END $$;
        </sql>
        
        <!-- Update index names -->
        <sql>
            DO $$
            DECLARE
                index_record RECORD;
            BEGIN
                FOR index_record IN
                    SELECT indexname, tablename
                    FROM pg_indexes
                    WHERE indexname LIKE '%ifrs16lease_contract%'
                LOOP
                    EXECUTE 'ALTER INDEX ' || index_record.indexname || 
                           ' RENAME TO ' || REPLACE(index_record.indexname, 'ifrs16lease_contract', 'detailed_lease_contract');
                END LOOP;
            END $$;
        </sql>
        
        <rollback>
            <renameTable oldTableName="detailed_lease_contract" newTableName="ifrs16lease_contract"/>
            <sql>
                ALTER SEQUENCE IF EXISTS detailed_lease_contract_seq RENAME TO ifrs16lease_contract_seq;
            </sql>
        </rollback>
    </changeSet>

</databaseChangeLog>
